var app=angular.module("billy-radio",["ui.bootstrap","ngWebSocket"]);app.factory("YoutubePlayerFactory",["$rootScope",function(t){var e={};return e.create=function(e){var i=this;$.getScript("http://www.youtube.com/iframe_api"),$('<div id="'+e+'"></div>').appendTo("body"),window.onYouTubeIframeAPIReady=function(){i.player=new YT.Player(e,{height:"200",width:"320",playerVars:{autohide:1,autoplay:0,controls:0,fs:1,disablekb:0,modestbranding:1,iv_load_policy:3,rel:0,showinfo:0,theme:"dark",color:"red"},events:{onReady:function(e){t.$broadcast("ready",e)},onStateChange:function(e){switch(e.data){case-1:t.$broadcast("loadstart");break;case 0:t.$broadcast("ended");break;case 1:t.$broadcast("playing");break;case 2:t.$broadcast("paused");break;case 5:t.$broadcast("loadstart")}},onError:function(e){t.$broadcast("error",e)}}})}},e.load_and_play=function(t){this.clear(),this.player.cueVideoById(t.link.substring(8)),this.player.playVideo(),this.track=t},e.play=function(){this.player.playVideo()},e.pause=function(){this.player.pauseVideo()},e.stop=function(){this.player.stopVideo(),t.$broadcast("paused")},e.clear=function(){this.stop(),this.player.clearVideo(),this.track=void 0},e.set_volume=function(t){this.player.setVolume(t)},e.seek=function(t){this.player.seekTo(t)},e.get_current_time=function(t){return this.player.getPlayerState()===-1?0:this.player.getCurrentTime()},e.get_duration=function(t){return this.player.getDuration()},e}]),app.service("MusicService",["$rootScope","YoutubePlayerFactory",function(t,e){this.init=function(){e.create("yt_player")},this.playing=!1,this.player=e,this.playlists={},this.name=void 0,this.index=0,this.load_and_play=function(t){this.track&&this.stop(),void 0!==t.index&&t.name?(this.track=this.playlists[t.name].tracks[t.index],this.name=t.name,this.index=t.index):(this.track=t.track,this.name=this.index=void 0),this.player.load_and_play(this.track)},this.play=function(){this.player.play()},this.pause=function(){this.player.pause()},this.stop=function(){this.player.stop()},this.seek=function(t){this.player.seek(t)},this.get_current_time=function(){return this.player.get_current_time()},this.get_duration=function(){return this.player.get_duration()},this.set_volume=function(t){this.player.set_volume(t),this.volume=t},this.set_playlists=function(t){this.playlists=t},this.get_playlists=function(){return this.playlists},this.add_playlist=function(t,e){this.playlists[t]=e},this.delete_playlist=function(t){return Object.keys(this.playlists).length>1&&(delete this.playlists[t],!0)},this.reposition=function(t,e,i){var n=this.playlists[t].tracks,a=n[e];n.splice(e,1),n.splice(e-i,0,a),this.index<e&&this.index+i<e&&(this.index+=i),this.index<e&&this.index+i>e&&(this.index-=i)},this.next=function(t){var e;e=t===!0?(this.index+1)%this.playlists[this.name].tracks.length:this.index+1<this.playlists[this.name].tracks.length?this.index+1:void 0,void 0!==e&&(this.load_and_play({name:this.name,index:e}),this.index=e)},this.previous=function(){var t=this.index-1>=0?this.index-1:this.playlists[this.name].tracks.length-1;t<this.playlists[this.name].tracks.length-1&&(this.load_and_play({name:this.name,index:t}),this.index=t)},this.add=function(t,e){this.playlists[t].tracks.push(e)},this.remove=function(t,e){this.playlists[t].tracks.splice(e,1)};var i=this;t.$on("playing",function(t){i.playing=!0}),t.$on("paused",function(t){i.playing=!1}),t.$on("ended",function(t){i.playing=!1})}]),app.service("ApiService",["$http","$websocket",function(t,e){this.last_status_update=void 0,this.tracks=[],this.position=[0,0],this.registrations=[];var i=this,n=e("ws://musesync.ewi.tudelft.nl:8000/ws/radio");n.onMessage(function(t){var e=JSON.parse(t.data);if(console.log("Got message: "+e.type),"status"==e.type)i.last_status_update=(new Date).getTime(),angular.copy(e.position,i.position);else if("data"==e.type)angular.copy(e.tracks,i.tracks),angular.copy(e.registrations,i.registrations);else if("registered"==e.type)i.registrations.push({user_id:e.user_id,user_name:e.user_name,time:e.time});else if("unregistered"==e.type)for(var n=0;n<i.registrations.length;n++)if(i.registrations[n].user_id==e.user_id){i.registrations.splice(n,1);break}}),this.register=function(t,e){n.send(JSON.stringify({type:"register",name:t,radio_id:e}))},this.unregister=function(t){n.send(JSON.stringify({type:"unregister",radio_id:t}))},this.post_clicklog=function(e){return t.post("//musesync.ewi.tudelft.nl:8000/api/clicklog?app=billy-radio",e).then(function(t){return t.data},null)}}]),app.service("HelperService",function(){this.padNumber=function(t,e){for(var i=String(t);i.length<(e||2);)i="0"+i;return i},this.formatTime=function(t){return t>=60?this.padNumber(Math.floor(t/60),2)+":"+this.padNumber(Math.round(t%60),2):"00:"+this.padNumber(Math.round(t),2)},this.getParameterByName=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},this.replaceParameter=function(t,e,i){var n=new RegExp("\\b("+e+"=).*?(&|$)");return t.search(n)>=0?t.replace(n,"$1"+i+"$2"):t+(t.indexOf("?")>0?"&":"?")+e+"="+i},this.formatString=function(){var t=Array.prototype.slice.call(arguments),e=t.shift();return e.replace(/\{(\d+)\}/g,function(e,i){return t[i]})}}),app.controller("MainCtrl",["$rootScope","$scope","$attrs","$interval","$uibModal","HelperService","MusicService","ApiService",function(t,e,i,n,a,s,r,o){e.radio="d3e6f1ac9e0365f5e0685204284cda6dab51a52b",e.musicservice=r,e.current_time=0,e.current_volume=50,e.start=function(){r.init(),t.$on("ready",function(t){e.$watch("tracks",function(t,e){l(t)},!0),e.$watch("position",function(t,e){d(t[0],t[1])},!0),n(function(){var t=r.get_current_time();e.current_time=t,e.current_time_str=s.formatTime(t),t=r.get_duration(),e.duration=t||1,e.duration_str=s.formatTime(t),e.remaining=Math.abs(e.current_time-e.duration),e.remaining_str=s.formatTime(e.remaining)},1e3)})},e.$on("ended",function(t){r.next(!0),c()}),e.set_volume=function(t){r.set_volume(t),e.current_volume=t},e.volume_click=function(t){var i=$(t.currentTarget).width(),n=t.offsetX/i*100;e.set_volume(n)};var l=function(t){r.set_playlists({default_playlistname:{tracks:t}}),r.load_and_play({name:"default_playlistname",index:0}),c()};e.tracks=o.tracks,e.position=o.position,e.registrations=o.registrations;var c=function(){o.post_clicklog({track:e.musicservice.track.link,user:e.user_name,volume:e.current_volume,radio:e.radio})},u=function(t,i){for(var n=0,a=0;a<t;a++)n+=e.tracks[a].duration;return n+=i},d=function(e,i){var n=u(e,i),a=u(r.index,r.get_current_time()),s=Math.abs(a-n);if(isNaN(s)){console.log("Can't calculate time difference right now, rescheduling");var l=t.$on("playing",function(t){var n=((new Date).getTime()-o.last_status_update)/1e3;d(e,i+n),l()})}else s>=5&&(console.log("Time difference is "+s+"s, correcting play position"),r.index!==e&&r.load_and_play({name:"default_playlistname",index:e}),r.seek(i))};e.close_widget=function(){parent.postMessage("close-widget","*")};var p=e.current_volume;window.onmessage=function(t){"restore-volume"===t.data?e.set_volume(p):"mute-volume"===t.data&&(p=e.current_volume,e.set_volume(0))},$(window).ready(function(){e.in_iframe=window.location!==window.parent.location}),e.start(),o.register("default_username",e.radio)}]),app.filter("range",function(){return function(t,e,i){return t.filter(function(t,n){return n>=e&&(n<i||void 0===i)})}}),app.filter("timeago",function(){function t(t){return $.timeago(new Date(1e3*t))}return t.$stateful=!0,t});